<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Envio de Emails - Blazee</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" v-cloak>
        <!-- Navigation -->
        <nav class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <span class="text-2xl font-bold text-blue-600">Blazee</span>
                        </div>
                        <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                            <a @click="currentView = 'test'" 
                               :class="[currentView === 'test' ? 'border-blue-500 text-gray-900' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700', 'inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium cursor-pointer']">
                                Teste de Envio
                            </a>
                            <a @click="currentView = 'schedule'"
                               :class="[currentView === 'schedule' ? 'border-blue-500 text-gray-900' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700', 'inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium cursor-pointer']">
                                Agendar Envio
                            </a>
                            <a @click="currentView = 'dashboard'"
                               :class="[currentView === 'dashboard' ? 'border-blue-500 text-gray-900' : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700', 'inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium cursor-pointer']">
                                Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Test Email View -->
            <div v-if="currentView === 'test'" class="bg-white shadow sm:rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Enviar Email de Teste</h3>
                    <div class="mt-6 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                        <div class="sm:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Template</label>
                            <select v-model="testForm.template" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option v-for="template in templates" :value="template">{{ template }}</option>
                            </select>
                        </div>

                        <div class="sm:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Email de Teste</label>
                            <div class="mt-1">
                                <input type="email" v-model="testForm.email" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>

                        <div class="sm:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Nome</label>
                            <div class="mt-1">
                                <input type="text" v-model="testForm.name" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>

                        <div class="sm:col-span-6">
                            <label class="block text-sm font-medium text-gray-700">Assunto</label>
                            <div class="mt-1">
                                <input type="text" v-model="testForm.subject" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>

                        <div class="sm:col-span-6">
                            <label class="block text-sm font-medium text-gray-700">Preview</label>
                            <div class="mt-1">
                                <input type="text" v-model="testForm.preview" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                            </div>
                        </div>

                        <div class="sm:col-span-6">
                            <div class="relative flex items-start">
                                <div class="flex items-center h-5">
                                    <input type="checkbox" v-model="testForm.schedule" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label class="font-medium text-gray-700">Agendar envio</label>
                                </div>
                            </div>
                        </div>

                        <template v-if="testForm.schedule">
                            <div class="sm:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">Data de Envio</label>
                                <div class="mt-1">
                                    <input type="date" v-model="testForm.date" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                </div>
                            </div>

                            <div class="sm:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">Hora de Envio</label>
                                <div class="mt-1">
                                    <input type="time" v-model="testForm.time" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="mt-6">
                        <button @click="sendTestEmail" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            {{ testForm.schedule ? 'Agendar Email de Teste' : 'Enviar Email de Teste' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Schedule View -->
            <div v-if="currentView === 'schedule'" class="space-y-6">
                <!-- Formulário de Agendamento -->
                <div class="bg-white shadow sm:rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Agendar Envio em Massa</h3>
                        <div class="mt-6 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                            <div class="sm:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">Template</label>
                                <select v-model="scheduleForm.template" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option v-for="template in templates" :value="template">{{ template }}</option>
                                </select>
                            </div>

                            <div class="sm:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">Data de Envio</label>
                                <div class="mt-1">
                                    <input type="date" v-model="scheduleForm.date" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                </div>
                            </div>

                            <div class="sm:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">Hora de Envio</label>
                                <div class="mt-1">
                                    <input type="time" v-model="scheduleForm.time" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                </div>
                            </div>

                            <div class="sm:col-span-6">
                                <label class="block text-sm font-medium text-gray-700">Assunto</label>
                                <div class="mt-1">
                                    <input type="text" v-model="scheduleForm.subject" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                </div>
                            </div>

                            <div class="sm:col-span-6">
                                <label class="block text-sm font-medium text-gray-700">Preview</label>
                                <div class="mt-1">
                                    <input type="text" v-model="scheduleForm.preview" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                </div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <button @click="scheduleEmails" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Agendar Envio
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lista de Agendamentos -->
                <div class="bg-white shadow sm:rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Agendamentos</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Template</th>
                                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assunto</th>
                                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr v-for="schedule in schedules" :key="schedule.id">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            {{ formatDateTime(schedule.datetime) }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {{ schedule.template }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {{ schedule.subject }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="getStatusBadgeClass(schedule.status)" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                                {{ getStatusText(schedule.status) }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <button v-if="schedule.status === 'pendente'" @click="cancelSchedule(schedule.id)" 
                                                    class="text-red-600 hover:text-red-900">
                                                Cancelar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="schedules.length === 0">
                                        <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                                            Nenhum agendamento encontrado
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard View -->
            <iframe v-if="currentView === 'dashboard'" src="/dashboard.html" class="w-full h-screen border-0"></iframe>
        </main>

        <!-- Notification -->
        <div v-if="notification.show" class="fixed bottom-0 right-0 m-6">
            <div :class="['rounded-md p-4', notification.type === 'success' ? 'bg-green-50' : 'bg-red-50']">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg v-if="notification.type === 'success'" class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <svg v-else class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p :class="['text-sm font-medium', notification.type === 'success' ? 'text-green-800' : 'text-red-800']">
                            {{ notification.message }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref } = Vue

        createApp({
            setup() {
                const currentView = ref('test')
                const templates = ref([])
                const notification = ref({ show: false, message: '', type: 'success' })
                const schedules = ref([])

                const testForm = ref({
                    template: '',
                    email: 'brunnovert98@gmail.com',
                    name: 'Brunno',
                    subject: '',
                    preview: '',
                    schedule: false,
                    date: '',
                    time: ''
                })

                const scheduleForm = ref({
                    template: '',
                    date: '',
                    time: '',
                    subject: '',
                    preview: ''
                })

                // Carrega a lista de templates
                async function loadTemplates() {
                    try {
                        const response = await fetch('/list_templates')
                        templates.value = await response.json()
                    } catch (error) {
                        showNotification('Erro ao carregar templates', 'error')
                    }
                }

                // Carrega a lista de agendamentos
                async function loadSchedules() {
                    try {
                        const response = await fetch('/schedules')
                        schedules.value = await response.json()
                    } catch (error) {
                        showNotification('Erro ao carregar agendamentos', 'error')
                    }
                }

                // Envia ou agenda email de teste
                async function sendTestEmail() {
                    try {
                        const endpoint = testForm.value.schedule ? '/schedule_test' : '/send_test'
                        const data = {
                            ...testForm.value,
                            datetime: testForm.value.schedule ? 
                                `${testForm.value.date} ${testForm.value.time}:00` : null
                        }

                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        })
                        
                        const result = await response.json()
                        if (result.success) {
                            showNotification(
                                testForm.value.schedule ? 
                                'Email de teste agendado com sucesso!' : 
                                'Email de teste enviado com sucesso!', 
                                'success'
                            )
                            if (testForm.value.schedule) {
                                loadSchedules()
                            }
                        } else {
                            showNotification(result.error || 'Erro ao processar email', 'error')
                        }
                    } catch (error) {
                        showNotification('Erro ao processar email', 'error')
                    }
                }

                // Agenda envio em massa
                async function scheduleEmails() {
                    try {
                        const datetime = `${scheduleForm.value.date} ${scheduleForm.value.time}:00`
                        const data = {
                            ...scheduleForm.value,
                            datetime
                        }

                        const response = await fetch('/schedule', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        })
                        
                        const result = await response.json()
                        if (result.success) {
                            showNotification('Envio agendado com sucesso!', 'success')
                            loadSchedules()
                        } else {
                            showNotification(result.error || 'Erro ao agendar envio', 'error')
                        }
                    } catch (error) {
                        showNotification('Erro ao agendar envio', 'error')
                    }
                }

                // Cancela um agendamento
                async function cancelSchedule(id) {
                    try {
                        const response = await fetch(`/cancel_schedule/${id}`, {
                            method: 'POST'
                        })
                        
                        const result = await response.json()
                        if (result.success) {
                            showNotification('Agendamento cancelado com sucesso!', 'success')
                            loadSchedules()
                        } else {
                            showNotification(result.error || 'Erro ao cancelar agendamento', 'error')
                        }
                    } catch (error) {
                        showNotification('Erro ao cancelar agendamento', 'error')
                    }
                }

                function showNotification(message, type = 'success') {
                    notification.value = { show: true, message, type }
                    setTimeout(() => {
                        notification.value.show = false
                    }, 5000)
                }

                function formatDateTime(datetime) {
                    return new Date(datetime).toLocaleString('pt-BR')
                }

                function getStatusBadgeClass(status) {
                    const classes = {
                        'pendente': 'bg-yellow-100 text-yellow-800',
                        'enviando': 'bg-blue-100 text-blue-800',
                        'concluido': 'bg-green-100 text-green-800',
                        'erro': 'bg-red-100 text-red-800',
                        'cancelado': 'bg-gray-100 text-gray-800'
                    }
                    return classes[status] || 'bg-gray-100 text-gray-800'
                }

                function getStatusText(status) {
                    const texts = {
                        'pendente': 'Pendente',
                        'enviando': 'Enviando',
                        'concluido': 'Concluído',
                        'erro': 'Erro',
                        'cancelado': 'Cancelado'
                    }
                    return texts[status] || status
                }

                // Carrega os dados iniciais
                loadTemplates()
                loadSchedules()
                // Atualiza os agendamentos a cada 30 segundos
                setInterval(loadSchedules, 30000)

                return {
                    currentView,
                    templates,
                    schedules,
                    testForm,
                    scheduleForm,
                    notification,
                    sendTestEmail,
                    scheduleEmails,
                    cancelSchedule,
                    formatDateTime,
                    getStatusBadgeClass,
                    getStatusText
                }
            }
        }).mount('#app')
    </script>
</body>
</html> 